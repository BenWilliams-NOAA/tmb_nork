library(TMB)
library(tidyverse)
compile("nork.cpp")

# need to load in the rest of the data to data folder
rec_age = 2
years = 1961:2020
T = length(years)
length_bins = 15:45
catch_obs = c(800, 3250, 6815, 12170, 17430, 10040, 6000, 5010,
                3630, 2245, 3875, 3880, 2820, 2550, 2520, 2275, 622, 554, 670, 810, 1477,
                3920, 3618, 1002, 185, 248, 483, 1107, 1527, 1716, 4528,7770 ,4820,
                5966, 5635, 3340, 2935, 3055, 5409, 3333, 3133, 3339, 5256,
                4811, 4522, 4958, 4187, 4052, 3952, 3902, 3444, 5077, 4879, 4278, 3945,
                3434, 1835, 2359, 2748, 2617)

catch_sd = c(rep(0.1, 60))
waa = c(29.7, 74.4, 136, 209.2, 288.5, 369.4, 448.5, 523.6, 593.2, 656.6, 713.6, 764.2, 808.7, 847.7, 881.5, 910.8, 936, 957.7, 976.2, 992.1, 1005.6, 1017.1, 1026.9, 1035.2, 1042.2, 1048.2, 1053.3, 1057.6, 1061.2, 1064.3, 1066.9, 1069.1, 1070.9, 1072.5, 1073.8, 1074.9, 1075.9, 1076.7, 1077.4, 1077.9, 1078.4, 1078.8, 1079.2, 1079.5, 1079.7, 1079.9, 1080.1, 1080.2, 1080.4, 1080.8)


maa = c(0.003730717, 0.007114453, 0.013525548, 0.025565162, 0.047802384, 0.087642403, 0.155271892, 0.260204279,
                0.402279271, 0.56290318, 0.711336288, 0.825031111, 0.900226422, 0.945250043, 0.970619488, 0.984427181,
                0.991800615, 0.995698124, 0.997747193, 0.998821405, 0.999383714, 0.999677831, 0.999831607, 0.99991199,
                0.999954004, 0.999975962, 0.999987437, 0.999993435, 0.999996569, 0.999998207, 0.999999063, 0.99999951,
                0.999999744, 0.999999866, 0.99999993, 0.999999963, 0.999999981, 0.99999999, 0.999999995, 0.999999997,
                0.999999999, 0.999999999, 1, 1, 1, 1, 1, 1, 1, 1)

srv_yrs = c(1990,1993,1996,1999,2001,2003,2005,2007,2009,2011,2013,2015,2017,2019,2020)
srv_obs = c(108220,104147,171359,113873,246060,116170,299780,190206,108760,165460,262513,96378,220873,128330,81296)
srv_sd = c(18405,16069,43735,17052,34316,24772,52376,27808,30927,38699,51139,18017,60191,29774,12478)
srv_ind = ifelse(years %in% srv_yrs, 1, 0)

fish_age_obs = t(readRDS('patc_obs.Rdata'))
fish_age_yrs = c(1998, 1999, 2000, 2001, 2002, 2004, 2005, 2006, 2008, 2010, 2012, 2014, 2016, 2018, 2020)
fish_age_ind = ifelse(years %in% fish_age_yrs, 1, 0)
fish_age_iss = c(28.15,39.22,58.43,46.86,59.96,79.29,52.72,56.70,69.46,69.88,87.42,100,86.61,84.39,62.81)

srv_age_obs = readRDS('pats_obs.Rdata')
srv_age_iss = c(28.2956716,28.79701882,42.0642524,38.89731882,89.35478366,30.94949752,77.79463763,100,95.15473983,80.08763593,82.37064037,72.44958071,86.31402473,68.90159616,83.77314565)
srv_age_ind = ifelse(years %in% srv_yrs, 1, 0)

fish_size_obs = t(readRDS('fish_length_comp.Rdata'))[,-16]
fish_size_yrs = c(1991:1997, 2003, 2007, 2009, 2011, 2013, 2015, 2017, 2019)
fish_size_ind = ifelse(years %in% fish_size_yrs, 1, 0)
fish_size_iss = c(75.26726344,69.14816858,50.37419992,42.92240026,59.25746028,46.44946559,31.08132207,75.28669445,93.45834552,	83.26921616,72.04997154,89.84393421,100,57.926279,77.11325166)

age_error = readRDS('age_error.Rdata')
size_age = readRDS('size_age.Rdata')

data = list(ages = ages,
            years = years,
            length_bins = 15:45,
            spawn_mo = 4,
            waa = waa,
            wt_mature = waa * maa,
            catch_obs = catch_obs,
            yr_catchwt = 1977,
            wt0 = 5,
            wt1 = 50,
            srv_ind = srv_ind,
            srv_obs = srv_obs,
            srv_sd = srv_sd,
            srv_wt = 0.25,
            fish_age_ind = fish_age_ind,
            fish_age_obs = fish_age_obs,
            fish_age_iss = fish_age_iss,
            fish_age_wt = 0.5,
            srv_age_ind = srv_age_ind,
            srv_age_obs = srv_age,
            srv_age_iss = srv_age_iss,
            srv_age_wt = 0.5,
            fish_size_ind = fish_size_ind,
            fish_size_obs = fish_size_obs,
            fish_size_iss = fish_size_iss,
            fish_size_wt = 0.5,
            age_error = age_error,
            size_age = size_age)
str(data)
pars = list(log_a50 = log(c(8.23719578492, 9.09355629491)),
            delta = c(1.91866640868, 4.31923047888),
            log_mean_F = -3.58385236595,
            log_Ft = c(-1.28306124683, 0.140199833981, 0.952641543234, 1.67793968633, 2.28974699704,
             1.91823978977, 1.51557034959, 1.40878774713, 1.12294109172, 0.646529313912,
              1.20801861960, 1.24452195275, 0.942561137836, 0.835801151139, 0.798114766724,
               0.644693350645, -0.735539824209, -1.02062427087, -0.991743165230, -0.920367489050,
                -0.403644808221, 0.516721388258, 0.389882559033, -0.981570055502, -2.79223891420,
                 -2.60309212227, -2.00728646156, -1.23024028545, -0.956209854061, -0.890429678442,
                  0.0349559024681, 0.546156698362, 0.0400591009128, 0.234941837688, 0.181355511206,
                   -0.335989512042, -0.463551439451, -0.416583500320, 0.167372898873,
                    -0.293055078553, -0.341087697776, -0.279675928688, 0.155952440289,
                     0.0591776963077, -0.00563314517619, 0.0822175014391, -0.0885440790171,
                      -0.113680406335, -0.120666350781, -0.106971346707, -0.196222087322,
                       0.238469258157, 0.258217566983, 0.185811847296, 0.161828748432,
                        0.0782651773294, -0.500389551457, -0.207598679635, -0.00551620573419,
                         -0.0956412655191),
            log_M = -2.82178176000,
            log_mean_R = 3.50391,
            log_Rt =  c(-0.999797306673, -1.17237515921, -1.31481440189, -1.29947684085, -1.19650952919,
                       -1.07269785625, -0.858740244220, -0.648271337659, -0.687069961675, 0.445219166778,
                        -0.468276695996, -0.563352814004, -0.453027729654, -0.584195538322, -0.429755690388,
                         0.614844946205, 0.243664403047, -0.400119220417, -0.500707835112, -0.335760494094,
                          -0.00147160235074, 0.205169356072, -0.589731491602, 0.662087934070, -0.0974724220631,
                           -0.772529863247, -0.459399034102, -0.338932984917, -1.22764801352, -0.470463642208,
                            -0.821606342481, -0.909630584967, -1.23654078531, 0.436194651298, 0.0259279936320,
                             -0.463748734096, -0.359703385166, 0.182589967526, -0.706622061830, -1.01841380990,
                              -0.793317388193, -1.45663999946, -2.24234182204, -2.25003316068, -1.76689920898,
                               -1.93202614806, -1.74725802806, -1.63462815593, -1.62908024719, -1.84514613721,
                                -2.16498687286, -1.76579171915, -1.89444424903, -1.60259969329, -1.75681180416,
                                 -1.48983850684, -1.39173905744, -1.25892345656, -1.18461587351, -1.12500000434),
            init_logRt = c(-1.19414750188, -1.19809591673, -1.20225344500, -1.20662780636, -1.21122735382,
             -1.21606506031, -1.22115043981, -1.22649216166, -1.23210097519, -1.23798650648, -1.24415861470, -1.25062646041,
              -1.25740132870, -1.26449234040, -1.27190998138, -1.27966176612, -1.28775584994, -1.29620121156, -1.30500561365,
               -1.31417494445, -1.32371409445, -1.33362760589, -1.34391631981, -1.35457991448, -1.36561634960, -1.37702228101,
                -1.38878689192, -1.40089855851, -1.41334175243, -1.42609004023, -1.43911454732, -1.45236085259, -1.46579792964, 
                -1.47936419813, -1.49298490737, -1.50655074209, -1.51992650551, -1.53271591530, -1.54357308125,
                 -1.54900822105, -1.54201844034,-1.514912098,-1.472277742,-1.443172231,-1.448016,-1.454437953,-1.413530046,-1.317843315),
            log_q = -0.145098139167)
 str(pars)           
dyn.load("nork")
obj = TMB::MakeADFun(data = data, 
                     parameters = pars,
                     DLL = "nork",
                     map = list(log_a50 = rep(factor(NA), 2),
                                delta = rep(factor(NA), 2),
                                # log_mean_F = factor(NA),
                                log_Ft = rep(factor(NA), T),
                                log_M = factor(NA),
                                log_mean_R = factor(NA),
                                log_Rt = rep(factor(NA), T),
                                init_logRt = rep(factor(NA), 48),
                                log_q = factor(NA)))
# Optimize the model
fit = nlminb(start = obj$par, objective = obj$fn, gradient = obj$gr)
sd = sdreport(obj)